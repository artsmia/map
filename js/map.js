//@ sourceMappingURL=map.map
// Generated by CoffeeScript 1.6.1
var $map, Map, Markers, xhr;

xhr = function(url, f) {
  var x;
  x = new XMLHttpRequest;
  x.open('get', url);
  x.send();
  return x.onreadystatechange = function() {
    if (x.readyState === 4) {
      return f(x);
    }
  };
};

Map = {
  init: function(url) {
    if (url == null) {
      url = 'galleries.json';
    }
    return xhr(url, function(x) {
      Markers.all = JSON.parse(x.responseText);
      return Map.mark();
    });
  },
  mark: function() {
    var gallery, mark, _i, _len, _ref, _ref1, _results;
    if (gallery = window.location.hash.match(/(\d+)/) || window.location.search.match(/G(\d+)/)) {
      Markers.clear();
      return (_ref = Markers.add(gallery[1])) != null ? typeof _ref.scrollIntoViewIfNeeded === "function" ? _ref.scrollIntoViewIfNeeded() : void 0 : void 0;
    } else if (false) {
      _ref1 = Object.keys(Markers.all);
      _results = [];
      for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
        mark = _ref1[_i];
        _results.push(Markers.add(mark, true));
      }
      return _results;
    }
  },
  svgify: function(floors, url_prefix, f) {
    var i, swap_floor, _i, _len, _results,
      _this = this;
    if (floors == null) {
      floors = [1, 2, 3];
    }
    if (url_prefix == null) {
      url_prefix = "";
    }
    swap_floor = function(floor, x) {
      var _ref;
      return (_ref = document.getElementById(floor)) != null ? _ref.innerHTML = x.responseText : void 0;
    };
    url_prefix = url_prefix + "svgs/";
    _results = [];
    for (_i = 0, _len = floors.length; _i < _len; _i++) {
      i = floors[_i];
      if (!Map.svg_enabled) {
        document.querySelector("#map img").setAttribute('src', "" + url_prefix + i + ".svg");
        if (f != null) {
          _results.push(setTimeout(f, 200));
        } else {
          _results.push(void 0);
        }
      } else {
        _results.push(xhr("" + url_prefix + i + ".svg", function(x) {
          swap_floor(i, x);
          return typeof f === "function" ? f() : void 0;
        }));
      }
    }
    return _results;
  },
  svg_enabled: function() {
    return Modernizr && Modernizr.svg;
  },
  get_gallery_id_from_event: function(e) {
    var t, _ref, _ref1;
    t = e.target;
    if (((_ref = t.parentElement) != null ? _ref.nodeName : void 0) === 'g') {
      while (!(t.nodeName === 'text' || t.parentElement.nodeName !== 'g')) {
        t = t.parentElement.querySelector('text') || t.parentElement;
      }
    } else {
      t = null;
    }
    return t != null ? (_ref1 = t.textContent.replace(/\s*/g, '').match(/(\d+)/)) != null ? _ref1[1] : void 0 : void 0;
  },
  touched: function(e) {
    var id;
    if (id = Map.get_gallery_id_from_event(e)) {
      return Map.clickCallback(id);
    }
  },
  hover: function(e) {
    var id;
    if (id = Map.get_gallery_id_from_event(e)) {
      return Map.hoverCallback(id);
    }
  },
  unhover: function(e) {
    return Map.unhoverCallback();
  }
};

Markers = {
  build: function(x, y, stroked) {
    var m;
    if (stroked == null) {
      stroked = false;
    }
    m = document.createElement('span');
    if (m.classList != null) {
      m.classList.add('marker');
      if (stroked) {
        m.classList.add('stroked');
      }
    } else {
      m.setAttribute('class', 'marker');
    }
    m.style.left = "" + x + "px";
    m.style.top = "" + y + "px";
    return m;
  },
  add: function(id, stroked) {
    var x, y, _ref, _ref1;
    if (stroked == null) {
      stroked = false;
    }
    id = "" + id;
    if (id && (Markers.all[id] != null)) {
      _ref = Markers.all[id], x = _ref[0], y = _ref[1];
      return (_ref1 = document.getElementById(id[0])) != null ? _ref1.appendChild(this.build(x, y, stroked)) : void 0;
    }
  },
  clear: function() {
    var d, _results;
    _results = [];
    while (d = document.querySelector('.marker')) {
      _results.push(d.parentNode.removeChild(d));
    }
    return _results;
  }
};

$map = document.querySelector('#map') || document;

$map.addEventListener('click', Map.touched);

$map.addEventListener('touchend', Map.touched);

$map.addEventListener('mouseover', Map.hover);

$map.addEventListener('mouseout', Map.unhover);
